/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { Directive, Input, Output, HostListener, Inject, EventEmitter, ElementRef, Renderer2, ChangeDetectorRef } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { HttpClient } from '@angular/common/http';
import { Meta } from '@angular/platform-browser';
import { Platform } from '@angular/cdk/platform';
import { of, interval, Subscription, EMPTY } from 'rxjs';
import { tap, take, switchMap, takeWhile, finalize, catchError } from 'rxjs/operators';
import { ShareService } from './share.service';
import { getValidUrl } from './utils';
export class ShareDirective {
    /**
     * @param {?} meta
     * @param {?} el
     * @param {?} http
     * @param {?} platform
     * @param {?} renderer
     * @param {?} cd
     * @param {?} shareService
     * @param {?} document
     */
    constructor(meta, el, http, platform, renderer, cd, shareService, document) {
        this.meta = meta;
        this.el = el;
        this.http = http;
        this.platform = platform;
        this.renderer = renderer;
        this.cd = cd;
        this.shareService = shareService;
        this.document = document;
        /**
         * share window closed subscription (to unsubscribe if the button is destroyed before the share window closes)
         */
        this._shareWindowClosed = Subscription.EMPTY;
        /**
         * Get share count
         */
        this.getCount = false;
        /**
         * Set meta tags from document head, useful when SEO is supported
         */
        this.autoSetMeta = this.shareService.autoSetMeta;
        /**
         * Meta tags inputs - initialized from the global options
         */
        this.url = this.shareService.url;
        this.title = this.shareService.title;
        this.description = this.shareService.description;
        this.image = this.shareService.image;
        this.tags = this.shareService.tags;
        /**
         * Stream that emits when share count is fetched
         */
        this.count = new EventEmitter();
        /**
         * Stream that emits when share dialog is opened
         */
        this.opened = new EventEmitter();
        /**
         * Stream that emits when share dialog is closed
         */
        this.closed = new EventEmitter();
    }
    /**
     * Share link on element click
     * @return {?}
     */
    onClick() {
        if (this.platform.isBrowser) {
            /** @type {?} */
            const metaTags = this.autoSetMeta ? {
                url: this.url,
                title: this.title || this.getMetaTagContent('og:title'),
                description: this.description || this.getMetaTagContent('og:description'),
                image: this.image || this.getMetaTagContent('og:image'),
                via: this.shareService.twitterAccount,
                tags: this.tags,
            } : {
                url: this.url,
                title: this.title,
                description: this.description,
                image: this.image,
                tags: this.tags,
                via: this.shareService.twitterAccount,
            };
            // Share the link
            // @ts-ignore
            of({
                el: this.el.nativeElement,
                renderer: this.renderer,
                prop: this.prop,
                cd: this.cd,
                document: this.document,
                platform: this.getPlatform(),
                metaTags
            }).pipe(...this.prop.share.operators, tap((sharerURL) => this.share(sharerURL)), take(1)).subscribe();
        }
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (this.platform.isBrowser) {
            if (changes['shareButton'] && (changes['shareButton'].firstChange || changes['shareButton'].previousValue !== this.shareButton)) {
                this.createShareButton(this.shareButton);
            }
            if (!this.url || (changes['url'] && changes['url'].previousValue !== this.url)) {
                this.url = getValidUrl(this.autoSetMeta
                    ? this.url || this.getMetaTagContent('og:url')
                    : this.url, this.document.defaultView.location.href);
                if (this.getCount && this.prop.count) {
                    this.shareCount(this.url).subscribe((count) => this.count.emit(count));
                }
            }
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this._shareWindowClosed.unsubscribe();
    }
    /**
     * Open sharing dialog
     * @param {?} url - Share URL
     * @return {?}
     */
    share(url) {
        if (url) {
            // GA Tracking
            if (this.shareService.gaTracking && ((/** @type {?} */ (this.document.defaultView))).ga) {
                ((/** @type {?} */ (this.document.defaultView))).ga('send', 'social', this.prop.type, 'click', this.url);
            }
            // Open share pop up and activate its opened and closed events
            this._shareWindowClosed = of(this.document.defaultView.open(url, 'newwindow', this.shareService.windowSize)).pipe(tap(() => this.opened.emit(this.prop.type)), switchMap((popUp) => interval(200).pipe(takeWhile(() => !popUp.closed))), finalize(() => this.closed.emit(this.prop.type))).subscribe();
        }
    }
    /**
     * @param {?} shareUrl
     * @return {?}
     */
    shareCount(shareUrl) {
        /** @type {?} */
        const options = this.prop.count;
        return options.request === 'jsonp'
            ?
                // @ts-ignore
                this.http.jsonp(options.url + shareUrl, 'callback').pipe(...options.operators, catchError(() => EMPTY))
            :
                // @ts-ignore
                this.http.get(options.url + shareUrl, options.args).pipe(...options.operators, catchError(() => EMPTY));
    }
    /**
     * @param {?} buttonsName
     * @return {?}
     */
    createShareButton(buttonsName) {
        /** @type {?} */
        const button = Object.assign({}, this.shareService.prop[buttonsName]);
        if (button) {
            // Set share button properties
            this.prop = button;
            // Remove previous button class
            this.renderer.removeClass(this.el.nativeElement, `sb-${this._buttonClass}`);
            // Add new button class
            this.renderer.addClass(this.el.nativeElement, `sb-${button.type}`);
            // Set button css color variable
            this.el.nativeElement.style.setProperty('--button-color', this.prop.color);
            // Keep a copy of the class for future replacement
            this._buttonClass = button.type;
            // Set aria-label attribute
            this.renderer.setAttribute(this.el.nativeElement, 'aria-label', button.ariaLabel || button.text);
        }
        else {
            throw new Error(`[ShareButtons]: The share button '${buttonsName}' does not exist!`);
        }
    }
    /**
     * Get meta tag content
     * @param {?} key
     * @return {?}
     */
    getMetaTagContent(key) {
        /** @type {?} */
        const metaUsingProperty = this.meta.getTag(`property="${key}"`);
        if (metaUsingProperty)
            return metaUsingProperty.getAttribute('content');
        /** @type {?} */
        const metaUsingName = this.meta.getTag(`name="${key}"`);
        if (metaUsingName)
            return metaUsingName.getAttribute('content');
    }
    /**
     * @return {?}
     */
    getPlatform() {
        if (this.platform.IOS)
            return 'ois';
        if (this.platform.ANDROID)
            return 'android';
        return 'desktop';
    }
}
ShareDirective.decorators = [
    { type: Directive, args: [{
                selector: '[shareButton], [share-button]'
            },] }
];
/** @nocollapse */
ShareDirective.ctorParameters = () => [
    { type: Meta },
    { type: ElementRef },
    { type: HttpClient },
    { type: Platform },
    { type: Renderer2 },
    { type: ChangeDetectorRef },
    { type: ShareService },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
ShareDirective.propDecorators = {
    shareButton: [{ type: Input }],
    getCount: [{ type: Input }],
    autoSetMeta: [{ type: Input }],
    url: [{ type: Input }],
    title: [{ type: Input }],
    description: [{ type: Input }],
    image: [{ type: Input }],
    tags: [{ type: Input }],
    count: [{ type: Output }],
    opened: [{ type: Output }],
    closed: [{ type: Output }],
    onClick: [{ type: HostListener, args: ['click',] }]
};
if (false) {
    /**
     * A ref to button class - used to remove previous class when the button type is changed
     * @type {?}
     */
    ShareDirective.prototype._buttonClass;
    /**
     * share window closed subscription (to unsubscribe if the button is destroyed before the share window closes)
     * @type {?}
     */
    ShareDirective.prototype._shareWindowClosed;
    /**
     * Button properties
     * @type {?}
     */
    ShareDirective.prototype.prop;
    /**
     * Share button type
     * @type {?}
     */
    ShareDirective.prototype.shareButton;
    /**
     * Get share count
     * @type {?}
     */
    ShareDirective.prototype.getCount;
    /**
     * Set meta tags from document head, useful when SEO is supported
     * @type {?}
     */
    ShareDirective.prototype.autoSetMeta;
    /**
     * Meta tags inputs - initialized from the global options
     * @type {?}
     */
    ShareDirective.prototype.url;
    /** @type {?} */
    ShareDirective.prototype.title;
    /** @type {?} */
    ShareDirective.prototype.description;
    /** @type {?} */
    ShareDirective.prototype.image;
    /** @type {?} */
    ShareDirective.prototype.tags;
    /**
     * Stream that emits when share count is fetched
     * @type {?}
     */
    ShareDirective.prototype.count;
    /**
     * Stream that emits when share dialog is opened
     * @type {?}
     */
    ShareDirective.prototype.opened;
    /**
     * Stream that emits when share dialog is closed
     * @type {?}
     */
    ShareDirective.prototype.closed;
    /** @type {?} */
    ShareDirective.prototype.meta;
    /** @type {?} */
    ShareDirective.prototype.el;
    /** @type {?} */
    ShareDirective.prototype.http;
    /** @type {?} */
    ShareDirective.prototype.platform;
    /** @type {?} */
    ShareDirective.prototype.renderer;
    /** @type {?} */
    ShareDirective.prototype.cd;
    /** @type {?} */
    ShareDirective.prototype.shareService;
    /** @type {?} */
    ShareDirective.prototype.document;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtYnV0dG9uLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtc2hhcmUvY29yZS8iLCJzb3VyY2VzIjpbImxpYi9zaGFyZS1idXR0b24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLE1BQU0sRUFJTixZQUFZLEVBQ1osVUFBVSxFQUNWLFNBQVMsRUFDVCxpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRWpELE9BQU8sRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFjLFlBQVksRUFBb0IsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUvQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBS3RDLE1BQU0sT0FBTyxjQUFjOzs7Ozs7Ozs7OztJQW9DekIsWUFBb0IsSUFBVSxFQUNWLEVBQWMsRUFDZCxJQUFnQixFQUNoQixRQUFrQixFQUNsQixRQUFtQixFQUNuQixFQUFxQixFQUNyQixZQUEwQixFQUNSLFFBQWE7UUFQL0IsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUNWLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDZCxTQUFJLEdBQUosSUFBSSxD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TCxLQUFLO21CQUNMLEtBQUs7b0JBR0wsTUFBTTtxQkFHTixNQUFNO3FCQUdOLE1BQU07c0JBYU4sWUFBWSxTQUFDLE9BQU87Ozs7Ozs7SUE1Q3JCLHNDQUE2Qjs7Ozs7SUFHN0IsNENBQWtFOzs7OztJQUdsRSw4QkFBbUI7Ozs7O0lBR25CLHFDQUE2Qjs7Ozs7SUFHN0Isa0NBQTBCOzs7OztJQUcxQixxQ0FBOEQ7Ozs7O0lBRzlELDZCQUE2Qzs7SUFDN0MsK0JBQWlEOztJQUNqRCxxQ0FBNkQ7O0lBQzdELCtCQUFpRDs7SUFDakQsOEJBQStDOzs7OztJQUcvQywrQkFBNkM7Ozs7O0lBRzdDLGdDQUE4Qzs7Ozs7SUFHOUMsZ0NBQThDOztJQUVsQyw4QkFBa0I7O0lBQ2xCLDRCQUFzQjs7SUFDdEIsOEJBQXdCOztJQUN4QixrQ0FBMEI7O0lBQzFCLGtDQUEyQjs7SUFDM0IsNEJBQTZCOztJQUM3QixzQ0FBa0M7O0lBQ2xDLGtDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgRGlyZWN0aXZlLFxyXG4gIElucHV0LFxyXG4gIE91dHB1dCxcclxuICBIb3N0TGlzdGVuZXIsXHJcbiAgSW5qZWN0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBPbkRlc3Ryb3ksXHJcbiAgU2ltcGxlQ2hhbmdlcyxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgRWxlbWVudFJlZixcclxuICBSZW5kZXJlcjIsXHJcbiAgQ2hhbmdlRGV0ZWN0b3JSZWZcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBNZXRhIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XHJcbmltcG9ydCB7IFBsYXRmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BsYXRmb3JtJztcclxuXHJcbmltcG9ydCB7IG9mLCBpbnRlcnZhbCwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCBTdWJzY3JpcHRpb25MaWtlLCBFTVBUWSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIHRha2UsIHN3aXRjaE1hcCwgdGFrZVdoaWxlLCBmaW5hbGl6ZSwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IFNoYXJlU2VydmljZSB9IGZyb20gJy4vc2hhcmUuc2VydmljZSc7XHJcbmltcG9ydCB7IElTaGFyZUJ1dHRvbiwgSVNoYXJlQ291bnQsIFNoYXJlQnV0dG9uUmVmIH0gZnJvbSAnLi9zaGFyZS5tb2RlbHMnO1xyXG5pbXBvcnQgeyBnZXRWYWxpZFVybCB9IGZyb20gJy4vdXRpbHMnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbc2hhcmVCdXR0b25dLCBbc2hhcmUtYnV0dG9uXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIFNoYXJlRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG5cclxuICAvKiogQSByZWYgdG8gYnV0dG9uIGNsYXNzIC0gdXNlZCB0byByZW1vdmUgcHJldmlvdXMgY2xhc3Mgd2hlbiB0aGUgYnV0dG9uIHR5cGUgaXMgY2hhbmdlZCAqL1xyXG4gIHByaXZhdGUgX2J1dHRvbkNsYXNzOiBzdHJpbmc7XHJcblxyXG4gIC8qKiBzaGFyZSB3aW5kb3cgY2xvc2VkIHN1YnNjcmlwdGlvbiAodG8gdW5zdWJzY3JpYmUgaWYgdGhlIGJ1dHRvbiBpcyBkZXN0cm95ZWQgYmVmb3JlIHRoZSBzaGFyZSB3aW5kb3cgY2xvc2VzKSAqL1xyXG4gIHByaXZhdGUgX3NoYXJlV2luZG93Q2xvc2VkOiBTdWJzY3JpcHRpb25MaWtlID0gU3Vic2NyaXB0aW9uLkVNUFRZO1xyXG5cclxuICAvKiogQnV0dG9uIHByb3BlcnRpZXMgKi9cclxuICBwcm9wOiBJU2hhcmVCdXR0b247XHJcblxyXG4gIC8qKiBTaGFyZSBidXR0b24gdHlwZSAqL1xyXG4gIEBJbnB1dCgpIHNoYXJlQnV0dG9uOiBzdHJpbmc7XHJcblxyXG4gIC8qKiBHZXQgc2hhcmUgY291bnQgKi9cclxuICBASW5wdXQoKSBnZXRDb3VudCA9IGZhbHNlO1xyXG5cclxuICAvKiogU2V0IG1ldGEgdGFncyBmcm9tIGRvY3VtZW50IGhlYWQsIHVzZWZ1bCB3aGVuIFNFTyBpcyBzdXBwb3J0ZWQgKi9cclxuICBASW5wdXQoKSBhdXRvU2V0TWV0YTogYm9vbGVhbiA9IHRoaXMuc2hhcmVTZXJ2aWNlLmF1dG9TZXRNZXRhO1xyXG5cclxuICAvKiogTWV0YSB0YWdzIGlucHV0cyAtIGluaXRpYWxpemVkIGZyb20gdGhlIGdsb2JhbCBvcHRpb25zICovXHJcbiAgQElucHV0KCkgdXJsOiBzdHJpbmcgPSB0aGlzLnNoYXJlU2VydmljZS51cmw7XHJcbiAgQElucHV0KCkgdGl0bGU6IHN0cmluZyA9IHRoaXMuc2hhcmVTZXJ2aWNlLnRpdGxlO1xyXG4gIEBJbnB1dCgpIGRlc2NyaXB0aW9uOiBzdHJpbmcgPSB0aGlzLnNoYXJlU2VydmljZS5kZXNjcmlwdGlvbjtcclxuICBASW5wdXQoKSBpbWFnZTogc3RyaW5nID0gdGhpcy5zaGFyZVNlcnZpY2UuaW1hZ2U7XHJcbiAgQElucHV0KCkgdGFnczogc3RyaW5nID0gdGhpcy5zaGFyZVNlcnZpY2UudGFncztcclxuXHJcbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2hhcmUgY291bnQgaXMgZmV0Y2hlZCAqL1xyXG4gIEBPdXRwdXQoKSBjb3VudCA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPigpO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzaGFyZSBkaWFsb2cgaXMgb3BlbmVkICovXHJcbiAgQE91dHB1dCgpIG9wZW5lZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzaGFyZSBkaWFsb2cgaXMgY2xvc2VkICovXHJcbiAgQE91dHB1dCgpIGNsb3NlZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1ldGE6IE1ldGEsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcclxuICAgICAgICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBwbGF0Zm9ybTogUGxhdGZvcm0sXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgY2Q6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgc2hhcmVTZXJ2aWNlOiBTaGFyZVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogYW55KSB7XHJcbiAgfVxyXG5cclxuICAvKiogU2hhcmUgbGluayBvbiBlbGVtZW50IGNsaWNrICovXHJcbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxyXG4gIG9uQ2xpY2soKSB7XHJcbiAgICBpZiAodGhpcy5wbGF0Zm9ybS5pc0Jyb3dzZXIpIHtcclxuICAgICAgY29uc3QgbWV0YVRhZ3MgPSB0aGlzLmF1dG9TZXRNZXRhID8ge1xyXG4gICAgICAgIHVybDogdGhpcy51cmwsXHJcbiAgICAgICAgdGl0bGU6IHRoaXMudGl0bGUgfHwgdGhpcy5nZXRNZXRhVGFnQ29udGVudCgnb2c6dGl0bGUnKSxcclxuICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5kZXNjcmlwdGlvbiB8fCB0aGlzLmdldE1ldGFUYWdDb250ZW50KCdvZzpkZXNjcmlwdGlvbicpLFxyXG4gICAgICAgIGltYWdlOiB0aGlzLmltYWdlIHx8IHRoaXMuZ2V0TWV0YVRhZ0NvbnRlbnQoJ29nOmltYWdlJyksXHJcbiAgICAgICAgdmlhOiB0aGlzLnNoYXJlU2VydmljZS50d2l0dGVyQWNjb3VudCxcclxuICAgICAgICB0YWdzOiB0aGlzLnRhZ3MsXHJcbiAgICAgIH0gOiB7XHJcbiAgICAgICAgdXJsOiB0aGlzLnVybCxcclxuICAgICAgICB0aXRsZTogdGhpcy50aXRsZSxcclxuICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5kZXNjcmlwdGlvbixcclxuICAgICAgICBpbWFnZTogdGhpcy5pbWFnZSxcclxuICAgICAgICB0YWdzOiB0aGlzLnRhZ3MsXHJcbiAgICAgICAgdmlhOiB0aGlzLnNoYXJlU2VydmljZS50d2l0dGVyQWNjb3VudCxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIFNoYXJlIHRoZSBsaW5rXHJcbiAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgb2Y8U2hhcmVCdXR0b25SZWY+KHtcclxuICAgICAgICBlbDogdGhpcy5lbC5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgIHJlbmRlcmVyOiB0aGlzLnJlbmRlcmVyLFxyXG4gICAgICAgIHByb3A6IHRoaXMucHJvcCxcclxuICAgICAgICBjZDogdGhpcy5jZCxcclxuICAgICAgICBkb2N1bWVudDogdGhpcy5kb2N1bWVudCxcclxuICAgICAgICBwbGF0Zm9ybTogdGhpcy5nZXRQbGF0Zm9ybSgpLFxyXG4gICAgICAgIG1ldGFUYWdzXHJcbiAgICAgIH0pLnBpcGUoXHJcbiAgICAgICAgLi4udGhpcy5wcm9wLnNoYXJlLm9wZXJhdG9ycyxcclxuICAgICAgICB0YXAoKHNoYXJlclVSTDogYW55KSA9PiB0aGlzLnNoYXJlKHNoYXJlclVSTCkpLFxyXG4gICAgICAgIHRha2UoMSlcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIGlmICh0aGlzLnBsYXRmb3JtLmlzQnJvd3Nlcikge1xyXG5cclxuICAgICAgaWYgKGNoYW5nZXNbJ3NoYXJlQnV0dG9uJ10gJiYgKGNoYW5nZXNbJ3NoYXJlQnV0dG9uJ10uZmlyc3RDaGFuZ2UgfHwgY2hhbmdlc1snc2hhcmVCdXR0b24nXS5wcmV2aW91c1ZhbHVlICE9PSB0aGlzLnNoYXJlQnV0dG9uKSkge1xyXG4gICAgICAgIHRoaXMuY3JlYXRlU2hhcmVCdXR0b24odGhpcy5zaGFyZUJ1dHRvbik7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICghdGhpcy51cmwgfHwgKGNoYW5nZXNbJ3VybCddICYmIGNoYW5nZXNbJ3VybCddLnByZXZpb3VzVmFsdWUgIT09IHRoaXMudXJsKSkge1xyXG4gICAgICAgIHRoaXMudXJsID0gZ2V0VmFsaWRVcmwoXHJcbiAgICAgICAgICB0aGlzLmF1dG9TZXRNZXRhXHJcbiAgICAgICAgICAgID8gdGhpcy51cmwgfHwgdGhpcy5nZXRNZXRhVGFnQ29udGVudCgnb2c6dXJsJylcclxuICAgICAgICAgICAgOiB0aGlzLnVybCxcclxuICAgICAgICAgIHRoaXMuZG9jdW1lbnQuZGVmYXVsdFZpZXcubG9jYXRpb24uaHJlZlxyXG4gICAgICAgICk7XHJcbiAgICAgICAgaWYgKHRoaXMuZ2V0Q291bnQgJiYgdGhpcy5wcm9wLmNvdW50KSB7XHJcbiAgICAgICAgICB0aGlzLnNoYXJlQ291bnQodGhpcy51cmwpLnN1YnNjcmliZSgoY291bnQ6IG51bWJlcikgPT4gdGhpcy5jb3VudC5lbWl0KGNvdW50KSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuX3NoYXJlV2luZG93Q2xvc2VkLnVuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBPcGVuIHNoYXJpbmcgZGlhbG9nXHJcbiAgICogQHBhcmFtIHVybCAtIFNoYXJlIFVSTFxyXG4gICAqL1xyXG4gIHNoYXJlKHVybDogc3RyaW5nKSB7XHJcbiAgICBpZiAodXJsKSB7XHJcblxyXG4gICAgICAvLyBHQSBUcmFja2luZ1xyXG4gICAgICBpZiAodGhpcy5zaGFyZVNlcnZpY2UuZ2FUcmFja2luZyAmJiAoPGFueT50aGlzLmRvY3VtZW50LmRlZmF1bHRWaWV3KS5nYSkge1xyXG4gICAgICAgICg8YW55PnRoaXMuZG9jdW1lbnQuZGVmYXVsdFZpZXcpLmdhKCdzZW5kJywgJ3NvY2lhbCcsIHRoaXMucHJvcC50eXBlLCAnY2xpY2snLCB0aGlzLnVybCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIE9wZW4gc2hhcmUgcG9wIHVwIGFuZCBhY3RpdmF0ZSBpdHMgb3BlbmVkIGFuZCBjbG9zZWQgZXZlbnRzXHJcbiAgICAgIHRoaXMuX3NoYXJlV2luZG93Q2xvc2VkID0gb2YodGhpcy5kb2N1bWVudC5kZWZhdWx0Vmlldy5vcGVuKHVybCwgJ25ld3dpbmRvdycsIHRoaXMuc2hhcmVTZXJ2aWNlLndpbmRvd1NpemUpKS5waXBlKFxyXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLm9wZW5lZC5lbWl0KHRoaXMucHJvcC50eXBlKSksXHJcbiAgICAgICAgc3dpdGNoTWFwKChwb3BVcDogYW55KSA9PiBpbnRlcnZhbCgyMDApLnBpcGUodGFrZVdoaWxlKCgpID0+ICFwb3BVcC5jbG9zZWQpKSksXHJcbiAgICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5jbG9zZWQuZW1pdCh0aGlzLnByb3AudHlwZSkpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzaGFyZUNvdW50KHNoYXJlVXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xyXG4gICAgY29uc3Qgb3B0aW9uczogSVNoYXJlQ291bnQgPSB0aGlzLnByb3AuY291bnQ7XHJcbiAgICByZXR1cm4gb3B0aW9ucy5yZXF1ZXN0ID09PSAnanNvbnAnXHJcbiAgICAgID9cclxuICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICB0aGlzLmh0dHAuanNvbnA8YW55PihvcHRpb25zLnVybCArIHNoYXJlVXJsLCAnY2FsbGJhY2snKS5waXBlKFxyXG4gICAgICAgIC4uLm9wdGlvbnMub3BlcmF0b3JzLFxyXG4gICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gRU1QVFkpLFxyXG4gICAgICApXHJcbiAgICAgIDpcclxuICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICB0aGlzLmh0dHAuZ2V0PGFueT4ob3B0aW9ucy51cmwgKyBzaGFyZVVybCwgb3B0aW9ucy5hcmdzKS5waXBlKFxyXG4gICAgICAgIC4uLm9wdGlvbnMub3BlcmF0b3JzLFxyXG4gICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gRU1QVFkpXHJcbiAgICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZVNoYXJlQnV0dG9uKGJ1dHRvbnNOYW1lOiBzdHJpbmcpIHtcclxuXHJcbiAgICBjb25zdCBidXR0b246IElTaGFyZUJ1dHRvbiA9IHsuLi50aGlzLnNoYXJlU2VydmljZS5wcm9wW2J1dHRvbnNOYW1lXX07XHJcblxyXG4gICAgaWYgKGJ1dHRvbikge1xyXG4gICAgICAvLyBTZXQgc2hhcmUgYnV0dG9uIHByb3BlcnRpZXNcclxuICAgICAgdGhpcy5wcm9wID0gYnV0dG9uO1xyXG5cclxuICAgICAgLy8gUmVtb3ZlIHByZXZpb3VzIGJ1dHRvbiBjbGFzc1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgYHNiLSR7dGhpcy5fYnV0dG9uQ2xhc3N9YCk7XHJcblxyXG4gICAgICAvLyBBZGQgbmV3IGJ1dHRvbiBjbGFzc1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgYHNiLSR7YnV0dG9uLnR5cGV9YCk7XHJcblxyXG4gICAgICAvLyBTZXQgYnV0dG9uIGNzcyBjb2xvciB2YXJpYWJsZVxyXG4gICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoJy0tYnV0dG9uLWNvbG9yJywgdGhpcy5wcm9wLmNvbG9yKTtcclxuXHJcbiAgICAgIC8vIEtlZXAgYSBjb3B5IG9mIHRoZSBjbGFzcyBmb3IgZnV0dXJlIHJlcGxhY2VtZW50XHJcbiAgICAgIHRoaXMuX2J1dHRvbkNsYXNzID0gYnV0dG9uLnR5cGU7XHJcblxyXG4gICAgICAvLyBTZXQgYXJpYS1sYWJlbCBhdHRyaWJ1dGVcclxuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYXJpYS1sYWJlbCcsIGJ1dHRvbi5hcmlhTGFiZWwgfHwgYnV0dG9uLnRleHQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBbU2hhcmVCdXR0b25zXTogVGhlIHNoYXJlIGJ1dHRvbiAnJHtidXR0b25zTmFtZX0nIGRvZXMgbm90IGV4aXN0IWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIEdldCBtZXRhIHRhZyBjb250ZW50ICovXHJcbiAgcHJpdmF0ZSBnZXRNZXRhVGFnQ29udGVudChrZXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBtZXRhVXNpbmdQcm9wZXJ0eTogSFRNTE1ldGFFbGVtZW50ID0gdGhpcy5tZXRhLmdldFRhZyhgcHJvcGVydHk9XCIke2tleX1cImApO1xyXG4gICAgaWYgKG1ldGFVc2luZ1Byb3BlcnR5KSByZXR1cm4gbWV0YVVzaW5nUHJvcGVydHkuZ2V0QXR0cmlidXRlKCdjb250ZW50Jyk7XHJcbiAgICBjb25zdCBtZXRhVXNpbmdOYW1lOiBIVE1MTWV0YUVsZW1lbnQgPSB0aGlzLm1ldGEuZ2V0VGFnKGBuYW1lPVwiJHtrZXl9XCJgKTtcclxuICAgIGlmIChtZXRhVXNpbmdOYW1lKSByZXR1cm4gbWV0YVVzaW5nTmFtZS5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0UGxhdGZvcm0oKSB7XHJcbiAgICBpZiAodGhpcy5wbGF0Zm9ybS5JT1MpIHJldHVybiAnb2lzJztcclxuICAgIGlmICh0aGlzLnBsYXRmb3JtLkFORFJPSUQpIHJldHVybiAnYW5kcm9pZCc7XHJcbiAgICByZXR1cm4gJ2Rlc2t0b3AnO1xyXG4gIH1cclxufVxyXG4iXX0=