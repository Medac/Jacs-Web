/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Directive, Input, Output, HostListener, Inject, EventEmitter, ElementRef, Renderer2, ChangeDetectorRef } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { HttpClient } from '@angular/common/http';
import { Meta } from '@angular/platform-browser';
import { Platform } from '@angular/cdk/platform';
import { of, interval, Subscription, EMPTY } from 'rxjs';
import { tap, take, switchMap, takeWhile, finalize, catchError } from 'rxjs/operators';
import { ShareService } from './share.service';
import { getValidUrl } from './utils';
var ShareDirective = /** @class */ (function () {
    function ShareDirective(meta, el, http, platform, renderer, cd, shareService, document) {
        this.meta = meta;
        this.el = el;
        this.http = http;
        this.platform = platform;
        this.renderer = renderer;
        this.cd = cd;
        this.shareService = shareService;
        this.document = document;
        /**
         * share window closed subscription (to unsubscribe if the button is destroyed before the share window closes)
         */
        this._shareWindowClosed = Subscription.EMPTY;
        /**
         * Get share count
         */
        this.getCount = false;
        /**
         * Set meta tags from document head, useful when SEO is supported
         */
        this.autoSetMeta = this.shareService.autoSetMeta;
        /**
         * Meta tags inputs - initialized from the global options
         */
        this.url = this.shareService.url;
        this.title = this.shareService.title;
        this.description = this.shareService.description;
        this.image = this.shareService.image;
        this.tags = this.shareService.tags;
        /**
         * Stream that emits when share count is fetched
         */
        this.count = new EventEmitter();
        /**
         * Stream that emits when share dialog is opened
         */
        this.opened = new EventEmitter();
        /**
         * Stream that emits when share dialog is closed
         */
        this.closed = new EventEmitter();
    }
    /** Share link on element click */
    /**
     * Share link on element click
     * @return {?}
     */
    ShareDirective.prototype.onClick = /**
     * Share link on element click
     * @return {?}
     */
    function () {
        var _this = this;
        var _a;
        if (this.platform.isBrowser) {
            /** @type {?} */
            var metaTags = this.autoSetMeta ? {
                url: this.url,
                title: this.title || this.getMetaTagContent('og:title'),
                description: this.description || this.getMetaTagContent('og:description'),
                image: this.image || this.getMetaTagContent('og:image'),
                via: this.shareService.twitterAccount,
                tags: this.tags,
            } : {
                url: this.url,
                title: this.title,
                description: this.description,
                image: this.image,
                tags: this.tags,
                via: this.shareService.twitterAccount,
            };
            // Share the link
            // @ts-ignore
            (_a = of({
                el: this.el.nativeElement,
                renderer: this.renderer,
                prop: this.prop,
                cd: this.cd,
                document: this.document,
                platform: this.getPlatform(),
                metaTags: metaTags
            })).pipe.apply(_a, tslib_1.__spread(this.prop.share.operators, [tap(function (sharerURL) { return _this.share(sharerURL); }),
                take(1)])).subscribe();
        }
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    ShareDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        if (this.platform.isBrowser) {
            if (changes['shareButton'] && (changes['shareButton'].firstChange || changes['shareButton'].previousValue !== this.shareButton)) {
                this.createShareButton(this.shareButton);
            }
            if (!this.url || (changes['url'] && changes['url'].previousValue !== this.url)) {
                this.url = getValidUrl(this.autoSetMeta
                    ? this.url || this.getMetaTagContent('og:url')
                    : this.url, this.document.defaultView.location.href);
                if (this.getCount && this.prop.count) {
                    this.shareCount(this.url).subscribe(function (count) { return _this.count.emit(count); });
                }
            }
        }
    };
    /**
     * @return {?}
     */
    ShareDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this._shareWindowClosed.unsubscribe();
    };
    /**
     * Open sharing dialog
     * @param url - Share URL
     */
    /**
     * Open sharing dialog
     * @param {?} url - Share URL
     * @return {?}
     */
    ShareDirective.prototype.share = /**
     * Open sharing dialog
     * @param {?} url - Share URL
     * @return {?}
     */
    function (url) {
        var _this = this;
        if (url) {
            // GA Tracking
            if (this.shareService.gaTracking && ((/** @type {?} */ (this.document.defaultView))).ga) {
                ((/** @type {?} */ (this.document.defaultView))).ga('send', 'social', this.prop.type, 'click', this.url);
            }
            // Open share pop up and activate its opened and closed events
            this._shareWindowClosed = of(this.document.defaultView.open(url, 'newwindow', this.shareService.windowSize)).pipe(tap(function () { return _this.opened.emit(_this.prop.type); }), switchMap(function (popUp) { return interval(200).pipe(takeWhile(function () { return !popUp.closed; })); }), finalize(function () { return _this.closed.emit(_this.prop.type); })).subscribe();
        }
    };
    /**
     * @param {?} shareUrl
     * @return {?}
     */
    ShareDirective.prototype.shareCount = /**
     * @param {?} shareUrl
     * @return {?}
     */
    function (shareUrl) {
        var _a, _b;
        /** @type {?} */
        var options = this.prop.count;
        return options.request === 'jsonp'
            ? 
            // @ts-ignore
            (_a = this.http.jsonp(options.url + shareUrl, 'callback')).pipe.apply(_a, tslib_1.__spread(options.operators, [catchError(function () { return EMPTY; })])) : 
        // @ts-ignore
        (_b = this.http.get(options.url + shareUrl, options.args)).pipe.apply(_b, tslib_1.__spread(options.operators, [catchError(function () { return EMPTY; })]));
    };
    /**
     * @param {?} buttonsName
     * @return {?}
     */
    ShareDirective.prototype.createShareButton = /**
     * @param {?} buttonsName
     * @return {?}
     */
    function (buttonsName) {
        /** @type {?} */
        var button = tslib_1.__assign({}, this.shareService.prop[buttonsName]);
        if (button) {
            // Set share button properties
            this.prop = button;
            // Remove previous button class
            this.renderer.removeClass(this.el.nativeElement, "sb-" + this._buttonClass);
            // Add new button class
            this.renderer.addClass(this.el.nativeElement, "sb-" + button.type);
            // Set button css color variable
            this.el.nativeElement.style.setProperty('--button-color', this.prop.color);
            // Keep a copy of the class for future replacement
            this._buttonClass = button.type;
            // Set aria-label attribute
            this.renderer.setAttribute(this.el.nativeElement, 'aria-label', button.ariaLabel || button.text);
        }
        else {
            throw new Error("[ShareButtons]: The share button '" + buttonsName + "' does not exist!");
        }
    };
    /** Get meta tag content */
    /**
     * Get meta tag content
     * @param {?} key
     * @return {?}
     */
    ShareDirective.prototype.getMetaTagContent = /**
     * Get meta tag content
     * @param {?} key
     * @return {?}
     */
    function (key) {
        /** @type {?} */
        var metaUsingProperty = this.meta.getTag("property=\"" + key + "\"");
        if (metaUsingProperty)
            return metaUsingProperty.getAttribute('content');
        /** @type {?} */
        var metaUsingName = this.meta.getTag("name=\"" + key + "\"");
        if (metaUsingName)
            return metaUsingName.getAttribute('content');
    };
    /**
     * @return {?}
     */
    ShareDirective.prototype.getPlatform = /**
     * @return {?}
     */
    function () {
        if (this.platform.IOS)
            return 'ois';
        if (this.platform.ANDROID)
            return 'android';
        return 'desktop';
    };
    ShareDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[shareButton], [share-button]'
                },] }
    ];
    /** @nocollapse */
    ShareDirective.ctorParameters = function () { return [
        { type: Meta },
        { type: ElementRef },
        { type: HttpClient },
        { type: Platform },
        { type: Renderer2 },
        { type: ChangeDetectorRef },
        { type: ShareService },
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    ShareDirective.propDecorators = {
        shareButton: [{ type: Input }],
        getCount: [{ type: Input }],
        autoSetMeta: [{ type: Input }],
        url: [{ type: Input }],
        title: [{ type: Input }],
        description: [{ type: Input }],
        image: [{ type: Input }],
        tags: [{ type: Input }],
        count: [{ type: Output }],
        opened: [{ type: Output }],
        closed: [{ type: Output }],
        onClick: [{ type: HostListener, args: ['click',] }]
    };
    return ShareDirective;
}());
export { ShareDirective };
if (false) {
    /**
     * A ref to button class - used to remove previous class when the button type is changed
     * @type {?}
     */
    ShareDirective.prototype._buttonClass;
    /**
     * share window closed subscription (to unsubscribe if the button is destroyed before the share window closes)
     * @type {?}
     */
    ShareDirective.prototype._shareWindowClosed;
    /**
     * Button properties
     * @type {?}
     */
    ShareDirective.prototype.prop;
    /**
     * Share button type
     * @type {?}
     */
    ShareDirective.prototype.shareButton;
    /**
     * Get share count
     * @type {?}
     */
    ShareDirective.prototype.getCount;
    /**
     * Set meta tags from document head, useful when SEO is supported
     * @type {?}
     */
    ShareDirective.prototype.autoSetMeta;
    /**
     * Meta tags inputs - initialized from the global options
     * @type {?}
     */
    ShareDirective.prototype.url;
    /** @type {?} */
    ShareDirective.prototype.title;
    /** @type {?} */
    ShareDirective.prototype.description;
    /** @type {?} */
    ShareDirective.prototype.image;
    /** @type {?} */
    ShareDirective.prototype.tags;
    /**
     * Stream that emits when share count is fetched
     * @type {?}
     */
    ShareDirective.prototype.count;
    /**
     * Stream that emits when share dialog is opened
     * @type {?}
     */
    ShareDirective.prototype.opened;
    /**
     * Stream that emits when share dialog is closed
     * @type {?}
     */
    ShareDirective.prototype.closed;
    /** @type {?} */
    ShareDirective.prototype.meta;
    /** @type {?} */
    ShareDirective.prototype.el;
    /** @type {?} */
    ShareDirective.prototype.http;
    /** @type {?} */
    ShareDirective.prototype.platform;
    /** @type {?} */
    ShareDirective.prototype.renderer;
    /** @type {?} */
    ShareDirective.prototype.cd;
    /** @type {?} */
    ShareDirective.prototype.shareService;
    /** @type {?} */
    ShareDirective.prototype.document;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtYnV0dG9uLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtc2hhcmUvY29yZS8iLCJzb3VyY2VzIjpbImxpYi9zaGFyZS1idXR0b24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixNQUFNLEVBSU4sWUFBWSxFQUNaLFVBQVUsRUFDVixTQUFTLEVBQ1QsaUJBQWlCLEVBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUVqRCxPQUFPLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBYyxZQUFZLEVBQW9CLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2RixPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV2RixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUV0QztJQXVDRSx3QkFBb0IsSUFBVSxFQUNWLEVBQWMsRUFDZCxJQUFnQixFQUNoQixRQUFrQixFQUNsQixRQUFtQixFQUNuQixFQUFxQixFQUNyQixZQUEwQixFQUNSLFFBQWE7UUFQL0IsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUNWLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDZCxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGFBQVEsR0FBUixRQUFR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UUFBUSxFQUFFLCtCQUErQjtpQkFDMUM7Ozs7Z0JBWlEsSUFBSTtnQkFOWCxVQUFVO2dCQUtILFVBQVU7Z0JBRVYsUUFBUTtnQkFOZixTQUFTO2dCQUNULGlCQUFpQjtnQkFVVixZQUFZO2dEQWtETixNQUFNLFNBQUMsUUFBUTs7OzhCQS9CM0IsS0FBSzsyQkFHTCxLQUFLOzhCQUdMLEtBQUs7c0JBR0wsS0FBSzt3QkFDTCxLQUFLOzhCQUNMLEtBQUs7d0JBQ0wsS0FBSzt1QkFDTCxLQUFLO3dCQUdMLE1BQU07eUJBR04sTUFBTTt5QkFHTixNQUFNOzBCQWFOLFlBQVksU0FBQyxPQUFPOztJQTRJdkIscUJBQUM7Q0FBQSxBQTlMRCxJQThMQztTQTNMWSxjQUFjOzs7Ozs7SUFHekIsc0NBQTZCOzs7OztJQUc3Qiw0Q0FBa0U7Ozs7O0lBR2xFLDhCQUFtQjs7Ozs7SUFHbkIscUNBQTZCOzs7OztJQUc3QixrQ0FBMEI7Ozs7O0lBRzFCLHFDQUE4RDs7Ozs7SUFHOUQsNkJBQTZDOztJQUM3QywrQkFBaUQ7O0lBQ2pELHFDQUE2RDs7SUFDN0QsK0JBQWlEOztJQUNqRCw4QkFBK0M7Ozs7O0lBRy9DLCtCQUE2Qzs7Ozs7SUFHN0MsZ0NBQThDOzs7OztJQUc5QyxnQ0FBOEM7O0lBRWxDLDhCQUFrQjs7SUFDbEIsNEJBQXNCOztJQUN0Qiw4QkFBd0I7O0lBQ3hCLGtDQUEwQjs7SUFDMUIsa0NBQTJCOztJQUMzQiw0QkFBNkI7O0lBQzdCLHNDQUFrQzs7SUFDbEMsa0NBQXVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsXHJcbiAgSW5wdXQsXHJcbiAgT3V0cHV0LFxyXG4gIEhvc3RMaXN0ZW5lcixcclxuICBJbmplY3QsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uRGVzdHJveSxcclxuICBTaW1wbGVDaGFuZ2VzLFxyXG4gIEV2ZW50RW1pdHRlcixcclxuICBFbGVtZW50UmVmLFxyXG4gIFJlbmRlcmVyMixcclxuICBDaGFuZ2VEZXRlY3RvclJlZlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IE1ldGEgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcclxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xyXG5cclxuaW1wb3J0IHsgb2YsIGludGVydmFsLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIFN1YnNjcmlwdGlvbkxpa2UsIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgdGFrZSwgc3dpdGNoTWFwLCB0YWtlV2hpbGUsIGZpbmFsaXplLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgU2hhcmVTZXJ2aWNlIH0gZnJvbSAnLi9zaGFyZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSVNoYXJlQnV0dG9uLCBJU2hhcmVDb3VudCwgU2hhcmVCdXR0b25SZWYgfSBmcm9tICcuL3NoYXJlLm1vZGVscyc7XHJcbmltcG9ydCB7IGdldFZhbGlkVXJsIH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tzaGFyZUJ1dHRvbl0sIFtzaGFyZS1idXR0b25dJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgU2hhcmVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcblxyXG4gIC8qKiBBIHJlZiB0byBidXR0b24gY2xhc3MgLSB1c2VkIHRvIHJlbW92ZSBwcmV2aW91cyBjbGFzcyB3aGVuIHRoZSBidXR0b24gdHlwZSBpcyBjaGFuZ2VkICovXHJcbiAgcHJpdmF0ZSBfYnV0dG9uQ2xhc3M6IHN0cmluZztcclxuXHJcbiAgLyoqIHNoYXJlIHdpbmRvdyBjbG9zZWQgc3Vic2NyaXB0aW9uICh0byB1bnN1YnNjcmliZSBpZiB0aGUgYnV0dG9uIGlzIGRlc3Ryb3llZCBiZWZvcmUgdGhlIHNoYXJlIHdpbmRvdyBjbG9zZXMpICovXHJcbiAgcHJpdmF0ZSBfc2hhcmVXaW5kb3dDbG9zZWQ6IFN1YnNjcmlwdGlvbkxpa2UgPSBTdWJzY3JpcHRpb24uRU1QVFk7XHJcblxyXG4gIC8qKiBCdXR0b24gcHJvcGVydGllcyAqL1xyXG4gIHByb3A6IElTaGFyZUJ1dHRvbjtcclxuXHJcbiAgLyoqIFNoYXJlIGJ1dHRvbiB0eXBlICovXHJcbiAgQElucHV0KCkgc2hhcmVCdXR0b246IHN0cmluZztcclxuXHJcbiAgLyoqIEdldCBzaGFyZSBjb3VudCAqL1xyXG4gIEBJbnB1dCgpIGdldENvdW50ID0gZmFsc2U7XHJcblxyXG4gIC8qKiBTZXQgbWV0YSB0YWdzIGZyb20gZG9jdW1lbnQgaGVhZCwgdXNlZnVsIHdoZW4gU0VPIGlzIHN1cHBvcnRlZCAqL1xyXG4gIEBJbnB1dCgpIGF1dG9TZXRNZXRhOiBib29sZWFuID0gdGhpcy5zaGFyZVNlcnZpY2UuYXV0b1NldE1ldGE7XHJcblxyXG4gIC8qKiBNZXRhIHRhZ3MgaW5wdXRzIC0gaW5pdGlhbGl6ZWQgZnJvbSB0aGUgZ2xvYmFsIG9wdGlvbnMgKi9cclxuICBASW5wdXQoKSB1cmw6IHN0cmluZyA9IHRoaXMuc2hhcmVTZXJ2aWNlLnVybDtcclxuICBASW5wdXQoKSB0aXRsZTogc3RyaW5nID0gdGhpcy5zaGFyZVNlcnZpY2UudGl0bGU7XHJcbiAgQElucHV0KCkgZGVzY3JpcHRpb246IHN0cmluZyA9IHRoaXMuc2hhcmVTZXJ2aWNlLmRlc2NyaXB0aW9uO1xyXG4gIEBJbnB1dCgpIGltYWdlOiBzdHJpbmcgPSB0aGlzLnNoYXJlU2VydmljZS5pbWFnZTtcclxuICBASW5wdXQoKSB0YWdzOiBzdHJpbmcgPSB0aGlzLnNoYXJlU2VydmljZS50YWdzO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzaGFyZSBjb3VudCBpcyBmZXRjaGVkICovXHJcbiAgQE91dHB1dCgpIGNvdW50ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XHJcblxyXG4gIC8qKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNoYXJlIGRpYWxvZyBpcyBvcGVuZWQgKi9cclxuICBAT3V0cHV0KCkgb3BlbmVkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcblxyXG4gIC8qKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNoYXJlIGRpYWxvZyBpcyBjbG9zZWQgKi9cclxuICBAT3V0cHV0KCkgY2xvc2VkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbWV0YTogTWV0YSxcclxuICAgICAgICAgICAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcclxuICAgICAgICAgICAgICBwcml2YXRlIHBsYXRmb3JtOiBQbGF0Zm9ybSxcclxuICAgICAgICAgICAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBjZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBzaGFyZVNlcnZpY2U6IFNoYXJlU2VydmljZSxcclxuICAgICAgICAgICAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvY3VtZW50OiBhbnkpIHtcclxuICB9XHJcblxyXG4gIC8qKiBTaGFyZSBsaW5rIG9uIGVsZW1lbnQgY2xpY2sgKi9cclxuICBASG9zdExpc3RlbmVyKCdjbGljaycpXHJcbiAgb25DbGljaygpIHtcclxuICAgIGlmICh0aGlzLnBsYXRmb3JtLmlzQnJvd3Nlcikge1xyXG4gICAgICBjb25zdCBtZXRhVGFncyA9IHRoaXMuYXV0b1NldE1ldGEgPyB7XHJcbiAgICAgICAgdXJsOiB0aGlzLnVybCxcclxuICAgICAgICB0aXRsZTogdGhpcy50aXRsZSB8fCB0aGlzLmdldE1ldGFUYWdDb250ZW50KCdvZzp0aXRsZScpLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLmRlc2NyaXB0aW9uIHx8IHRoaXMuZ2V0TWV0YVRhZ0NvbnRlbnQoJ29nOmRlc2NyaXB0aW9uJyksXHJcbiAgICAgICAgaW1hZ2U6IHRoaXMuaW1hZ2UgfHwgdGhpcy5nZXRNZXRhVGFnQ29udGVudCgnb2c6aW1hZ2UnKSxcclxuICAgICAgICB2aWE6IHRoaXMuc2hhcmVTZXJ2aWNlLnR3aXR0ZXJBY2NvdW50LFxyXG4gICAgICAgIHRhZ3M6IHRoaXMudGFncyxcclxuICAgICAgfSA6IHtcclxuICAgICAgICB1cmw6IHRoaXMudXJsLFxyXG4gICAgICAgIHRpdGxlOiB0aGlzLnRpdGxlLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgIGltYWdlOiB0aGlzLmltYWdlLFxyXG4gICAgICAgIHRhZ3M6IHRoaXMudGFncyxcclxuICAgICAgICB2aWE6IHRoaXMuc2hhcmVTZXJ2aWNlLnR3aXR0ZXJBY2NvdW50LFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy8gU2hhcmUgdGhlIGxpbmtcclxuICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICBvZjxTaGFyZUJ1dHRvblJlZj4oe1xyXG4gICAgICAgIGVsOiB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsXHJcbiAgICAgICAgcmVuZGVyZXI6IHRoaXMucmVuZGVyZXIsXHJcbiAgICAgICAgcHJvcDogdGhpcy5wcm9wLFxyXG4gICAgICAgIGNkOiB0aGlzLmNkLFxyXG4gICAgICAgIGRvY3VtZW50OiB0aGlzLmRvY3VtZW50LFxyXG4gICAgICAgIHBsYXRmb3JtOiB0aGlzLmdldFBsYXRmb3JtKCksXHJcbiAgICAgICAgbWV0YVRhZ3NcclxuICAgICAgfSkucGlwZShcclxuICAgICAgICAuLi50aGlzLnByb3Auc2hhcmUub3BlcmF0b3JzLFxyXG4gICAgICAgIHRhcCgoc2hhcmVyVVJMOiBhbnkpID0+IHRoaXMuc2hhcmUoc2hhcmVyVVJMKSksXHJcbiAgICAgICAgdGFrZSgxKVxyXG4gICAgICApLnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgaWYgKHRoaXMucGxhdGZvcm0uaXNCcm93c2VyKSB7XHJcblxyXG4gICAgICBpZiAoY2hhbmdlc1snc2hhcmVCdXR0b24nXSAmJiAoY2hhbmdlc1snc2hhcmVCdXR0b24nXS5maXJzdENoYW5nZSB8fCBjaGFuZ2VzWydzaGFyZUJ1dHRvbiddLnByZXZpb3VzVmFsdWUgIT09IHRoaXMuc2hhcmVCdXR0b24pKSB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVTaGFyZUJ1dHRvbih0aGlzLnNoYXJlQnV0dG9uKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCF0aGlzLnVybCB8fCAoY2hhbmdlc1sndXJsJ10gJiYgY2hhbmdlc1sndXJsJ10ucHJldmlvdXNWYWx1ZSAhPT0gdGhpcy51cmwpKSB7XHJcbiAgICAgICAgdGhpcy51cmwgPSBnZXRWYWxpZFVybChcclxuICAgICAgICAgIHRoaXMuYXV0b1NldE1ldGFcclxuICAgICAgICAgICAgPyB0aGlzLnVybCB8fCB0aGlzLmdldE1ldGFUYWdDb250ZW50KCdvZzp1cmwnKVxyXG4gICAgICAgICAgICA6IHRoaXMudXJsLFxyXG4gICAgICAgICAgdGhpcy5kb2N1bWVudC5kZWZhdWx0Vmlldy5sb2NhdGlvbi5ocmVmXHJcbiAgICAgICAgKTtcclxuICAgICAgICBpZiAodGhpcy5nZXRDb3VudCAmJiB0aGlzLnByb3AuY291bnQpIHtcclxuICAgICAgICAgIHRoaXMuc2hhcmVDb3VudCh0aGlzLnVybCkuc3Vic2NyaWJlKChjb3VudDogbnVtYmVyKSA9PiB0aGlzLmNvdW50LmVtaXQoY291bnQpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5fc2hhcmVXaW5kb3dDbG9zZWQudW5zdWJzY3JpYmUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE9wZW4gc2hhcmluZyBkaWFsb2dcclxuICAgKiBAcGFyYW0gdXJsIC0gU2hhcmUgVVJMXHJcbiAgICovXHJcbiAgc2hhcmUodXJsOiBzdHJpbmcpIHtcclxuICAgIGlmICh1cmwpIHtcclxuXHJcbiAgICAgIC8vIEdBIFRyYWNraW5nXHJcbiAgICAgIGlmICh0aGlzLnNoYXJlU2VydmljZS5nYVRyYWNraW5nICYmICg8YW55PnRoaXMuZG9jdW1lbnQuZGVmYXVsdFZpZXcpLmdhKSB7XHJcbiAgICAgICAgKDxhbnk+dGhpcy5kb2N1bWVudC5kZWZhdWx0VmlldykuZ2EoJ3NlbmQnLCAnc29jaWFsJywgdGhpcy5wcm9wLnR5cGUsICdjbGljaycsIHRoaXMudXJsKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gT3BlbiBzaGFyZSBwb3AgdXAgYW5kIGFjdGl2YXRlIGl0cyBvcGVuZWQgYW5kIGNsb3NlZCBldmVudHNcclxuICAgICAgdGhpcy5fc2hhcmVXaW5kb3dDbG9zZWQgPSBvZih0aGlzLmRvY3VtZW50LmRlZmF1bHRWaWV3Lm9wZW4odXJsLCAnbmV3d2luZG93JywgdGhpcy5zaGFyZVNlcnZpY2Uud2luZG93U2l6ZSkpLnBpcGUoXHJcbiAgICAgICAgdGFwKCgpID0+IHRoaXMub3BlbmVkLmVtaXQodGhpcy5wcm9wLnR5cGUpKSxcclxuICAgICAgICBzd2l0Y2hNYXAoKHBvcFVwOiBhbnkpID0+IGludGVydmFsKDIwMCkucGlwZSh0YWtlV2hpbGUoKCkgPT4gIXBvcFVwLmNsb3NlZCkpKSxcclxuICAgICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLmNsb3NlZC5lbWl0KHRoaXMucHJvcC50eXBlKSlcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNoYXJlQ291bnQoc2hhcmVVcmw6IHN0cmluZyk6IE9ic2VydmFibGU8bnVtYmVyPiB7XHJcbiAgICBjb25zdCBvcHRpb25zOiBJU2hhcmVDb3VudCA9IHRoaXMucHJvcC5jb3VudDtcclxuICAgIHJldHVybiBvcHRpb25zLnJlcXVlc3QgPT09ICdqc29ucCdcclxuICAgICAgP1xyXG4gICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgIHRoaXMuaHR0cC5qc29ucDxhbnk+KG9wdGlvbnMudXJsICsgc2hhcmVVcmwsICdjYWxsYmFjaycpLnBpcGUoXHJcbiAgICAgICAgLi4ub3B0aW9ucy5vcGVyYXRvcnMsXHJcbiAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBFTVBUWSksXHJcbiAgICAgIClcclxuICAgICAgOlxyXG4gICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgIHRoaXMuaHR0cC5nZXQ8YW55PihvcHRpb25zLnVybCArIHNoYXJlVXJsLCBvcHRpb25zLmFyZ3MpLnBpcGUoXHJcbiAgICAgICAgLi4ub3B0aW9ucy5vcGVyYXRvcnMsXHJcbiAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBFTVBUWSlcclxuICAgICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlU2hhcmVCdXR0b24oYnV0dG9uc05hbWU6IHN0cmluZykge1xyXG5cclxuICAgIGNvbnN0IGJ1dHRvbjogSVNoYXJlQnV0dG9uID0gey4uLnRoaXMuc2hhcmVTZXJ2aWNlLnByb3BbYnV0dG9uc05hbWVdfTtcclxuXHJcbiAgICBpZiAoYnV0dG9uKSB7XHJcbiAgICAgIC8vIFNldCBzaGFyZSBidXR0b24gcHJvcGVydGllc1xyXG4gICAgICB0aGlzLnByb3AgPSBidXR0b247XHJcblxyXG4gICAgICAvLyBSZW1vdmUgcHJldmlvdXMgYnV0dG9uIGNsYXNzXHJcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5lbC5uYXRpdmVFbGVtZW50LCBgc2ItJHt0aGlzLl9idXR0b25DbGFzc31gKTtcclxuXHJcbiAgICAgIC8vIEFkZCBuZXcgYnV0dG9uIGNsYXNzXHJcbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5lbC5uYXRpdmVFbGVtZW50LCBgc2ItJHtidXR0b24udHlwZX1gKTtcclxuXHJcbiAgICAgIC8vIFNldCBidXR0b24gY3NzIGNvbG9yIHZhcmlhYmxlXHJcbiAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS1idXR0b24tY29sb3InLCB0aGlzLnByb3AuY29sb3IpO1xyXG5cclxuICAgICAgLy8gS2VlcCBhIGNvcHkgb2YgdGhlIGNsYXNzIGZvciBmdXR1cmUgcmVwbGFjZW1lbnRcclxuICAgICAgdGhpcy5fYnV0dG9uQ2xhc3MgPSBidXR0b24udHlwZTtcclxuXHJcbiAgICAgIC8vIFNldCBhcmlhLWxhYmVsIGF0dHJpYnV0ZVxyXG4gICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdhcmlhLWxhYmVsJywgYnV0dG9uLmFyaWFMYWJlbCB8fCBidXR0b24udGV4dCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFtTaGFyZUJ1dHRvbnNdOiBUaGUgc2hhcmUgYnV0dG9uICcke2J1dHRvbnNOYW1lfScgZG9lcyBub3QgZXhpc3QhYCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IG1ldGEgdGFnIGNvbnRlbnQgKi9cclxuICBwcml2YXRlIGdldE1ldGFUYWdDb250ZW50KGtleTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IG1ldGFVc2luZ1Byb3BlcnR5OiBIVE1MTWV0YUVsZW1lbnQgPSB0aGlzLm1ldGEuZ2V0VGFnKGBwcm9wZXJ0eT1cIiR7a2V5fVwiYCk7XHJcbiAgICBpZiAobWV0YVVzaW5nUHJvcGVydHkpIHJldHVybiBtZXRhVXNpbmdQcm9wZXJ0eS5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnKTtcclxuICAgIGNvbnN0IG1ldGFVc2luZ05hbWU6IEhUTUxNZXRhRWxlbWVudCA9IHRoaXMubWV0YS5nZXRUYWcoYG5hbWU9XCIke2tleX1cImApO1xyXG4gICAgaWYgKG1ldGFVc2luZ05hbWUpIHJldHVybiBtZXRhVXNpbmdOYW1lLmdldEF0dHJpYnV0ZSgnY29udGVudCcpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRQbGF0Zm9ybSgpIHtcclxuICAgIGlmICh0aGlzLnBsYXRmb3JtLklPUykgcmV0dXJuICdvaXMnO1xyXG4gICAgaWYgKHRoaXMucGxhdGZvcm0uQU5EUk9JRCkgcmV0dXJuICdhbmRyb2lkJztcclxuICAgIHJldHVybiAnZGVza3RvcCc7XHJcbiAgfVxyXG59XHJcbiJdfQ==